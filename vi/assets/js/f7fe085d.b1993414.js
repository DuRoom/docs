"use strict";(self.webpackChunkduroom_docs=self.webpackChunkduroom_docs||[]).push([[4083],{3905:function(e,t,n){n.d(t,{Zo:function(){return u},kt:function(){return h}});var a=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=a.createContext({}),c=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},u=function(e){var t=c(e.components);return a.createElement(l.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,o=e.originalType,l=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),d=c(n),h=i,m=d["".concat(l,".").concat(h)]||d[h]||p[h]||o;return n?a.createElement(m,r(r({ref:t},u),{},{components:n})):a.createElement(m,r({ref:t},u))}));function h(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var o=n.length,r=new Array(o);r[0]=d;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:i,r[1]=s;for(var c=2;c<o;c++)r[c]=n[c];return a.createElement.apply(null,r)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},9006:function(e,t,n){n.r(t),n.d(t,{assets:function(){return u},contentTitle:function(){return l},default:function(){return h},frontMatter:function(){return s},metadata:function(){return c},toc:function(){return p}});var a=n(7462),i=n(3366),o=(n(7294),n(3905)),r=["components"],s={},l="Authorization",c={unversionedId:"extend/authorization",id:"extend/authorization",title:"Authorization",description:"As with any framework, DuRoom allows certain actions and content to be restricted to certain users. There are 2 parallel systems for this:",source:"@site/docs/extend/authorization.md",sourceDirName:"extend",slug:"/extend/authorization",permalink:"/vi/extend/authorization",draft:!1,editUrl:"https://github.com/DuRoom/docs/tree/master/docs/extend/authorization.md",tags:[],version:"current",frontMatter:{},sidebar:"extendSidebar",previous:{title:"Backend Events",permalink:"/vi/extend/backend-events"},next:{title:"Frontend Pages and Resolvers",permalink:"/vi/extend/frontend-pages"}},u={},p=[{value:"Authorization Process",id:"authorization-process",level:2},{value:"How It Works",id:"how-it-works",level:2},{value:"How To Use Authorization",id:"how-to-use-authorization",level:2},{value:"Custom Policies",id:"custom-policies",level:2},{value:"Example Policies",id:"example-policies",level:3},{value:"Registering Policies",id:"registering-policies",level:3},{value:"Frontend Authorization",id:"frontend-authorization",level:2}],d={toc:p};function h(e){var t=e.components,n=(0,i.Z)(e,r);return(0,o.kt)("wrapper",(0,a.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"authorization"},"Authorization"),(0,o.kt)("p",null,"As with any framework, DuRoom allows certain actions and content to be restricted to certain users. There are 2 parallel systems for this:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"The authorization process dictates whether a user can take a certain action."),(0,o.kt)("li",{parentName:"ul"},"Visibility scoping can be applied to a database query to efficiently restrict the records that users can access. This is documented in our ",(0,o.kt)("a",{parentName:"li",href:"/vi/extend/model-visibility"},"model visibility")," article.")),(0,o.kt)("h2",{id:"authorization-process"},"Authorization Process"),(0,o.kt)("p",null,"The authorization process is used to check whether a person is allowed to perform certain actions. For instance, we want to check if a user is authorized before they:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Access the admin dashboard"),(0,o.kt)("li",{parentName:"ul"},"Start a discussion"),(0,o.kt)("li",{parentName:"ul"},"Edit a post"),(0,o.kt)("li",{parentName:"ul"},"Update another user's profile")),(0,o.kt)("p",null,"Each of these is determined by unique criteria: in some cases a flag is sufficient; otherwise, we might need custom logic."),(0,o.kt)("h2",{id:"how-it-works"},"How It Works"),(0,o.kt)("p",null,"Authorization queries are made with 3 parameters, with logic contained in ",(0,o.kt)("a",{parentName:"p",href:"https://api.duroom.js.org/docs/php/master/duroom/user/access/gate"},(0,o.kt)("inlineCode",{parentName:"a"},"DuRoom\\User\\Gate")),":"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"The actor: the user attempting to perform the action"),(0,o.kt)("li",{parentName:"ol"},"The ability: a string representing the action the actor is attempting"),(0,o.kt)("li",{parentName:"ol"},"The arguments: usually an instance of a database model which is the subject of the attempted ability, but could be anything.")),(0,o.kt)("p",null,"First, we run the entire request (all three parameters) through all ",(0,o.kt)("a",{parentName:"p",href:"#policies"},"policies")," registered by extensions and core. Policies are blocks of logic provided by core and extensions that determine whether the actor can perform the ability on the arguments. Policies can return one of the following:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"DuRoom\\User\\Access\\AbstractPolicy::ALLOW")," (via ",(0,o.kt)("inlineCode",{parentName:"li"},"$this->allow()"),")"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"DuRoom\\User\\Access\\AbstractPolicy::DENY")," (via ",(0,o.kt)("inlineCode",{parentName:"li"},"$this->deny()"),")"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"DuRoom\\User\\Access\\AbstractPolicy::FORCE_ALLOW")," (via ",(0,o.kt)("inlineCode",{parentName:"li"},"$this->forceAllow()"),")"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"DuRoom\\User\\Access\\AbstractPolicy::FORCE_DENY")," (via ",(0,o.kt)("inlineCode",{parentName:"li"},"$this->forceDeny()"),")")),(0,o.kt)("p",null,"Policy results are considered in the priority ",(0,o.kt)("inlineCode",{parentName:"p"},"FORCE_DENY")," > ",(0,o.kt)("inlineCode",{parentName:"p"},"FORCE_ALLOW")," > ",(0,o.kt)("inlineCode",{parentName:"p"},"DENY")," > ",(0,o.kt)("inlineCode",{parentName:"p"},"ALLOW"),". For example, if a single policy returns ",(0,o.kt)("inlineCode",{parentName:"p"},"FORCE_DENY"),", all other policies will be ignored. If one policy returns ",(0,o.kt)("inlineCode",{parentName:"p"},"DENY")," and 10 policies return ",(0,o.kt)("inlineCode",{parentName:"p"},"ALLOW"),", the request will be denied. This allows decisions to be made regardless of the order in which extensions are booted. Note that policies are extremely powerful: if access is denied at the policy stage, that will override group permissions and even admin privileges."),(0,o.kt)("p",null,"Secondly, if all policies return null (or don't return anything), we check if the user is in a group that has a permission equal to the ability (note that both permissions and abilities are represented as strings). If so, we authorize the action.\nSee our ",(0,o.kt)("a",{parentName:"p",href:"/vi/extend/permissions"},"Groups and Permissions documentation")," for more information on permissions."),(0,o.kt)("p",null,"Then, if the user is in the admin group, we will authorize the action."),(0,o.kt)("p",null,"Finally, as we have exhausted all checks, we will assume that the user is unauthorized and deny the request."),(0,o.kt)("h2",{id:"how-to-use-authorization"},"How To Use Authorization"),(0,o.kt)("p",null,"DuRoom's authorization system is accessible through public methods of the ",(0,o.kt)("inlineCode",{parentName:"p"},"DuRoom\\User\\User")," class. The most important ones are listed below; others are documented in our ",(0,o.kt)("a",{parentName:"p",href:"https://api.duroom.js.org/docs/php/master/duroom/user/user"},"PHP API documentation"),"."),(0,o.kt)("p",null,"In this example, we will use ",(0,o.kt)("inlineCode",{parentName:"p"},"$actor")," as an instance of ",(0,o.kt)("inlineCode",{parentName:"p"},"DuRoom\\User\\User"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"'viewForum'")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"'reply'")," as examples of abilities, and ",(0,o.kt)("inlineCode",{parentName:"p"},"$discussion")," (instance of ",(0,o.kt)("inlineCode",{parentName:"p"},"DuRoom\\Discussion\\Discussion"),") as an example argument."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-php"},"// Check whether a user can perform an action.\n$canDoSomething = $actor->can('viewForum');\n\n// Check whether a user can perform an action on a subject.\n$canDoSomething = $actor->can('reply', $discussion);\n\n// Raise a PermissionDeniedException if a user cannot perform an action.\n$actor->assertCan('viewForum');\n$actor->assertCan('reply', $discussion);\n\n// Raise a NotAuthenticatedException if the user is not logged in.\n$actor->assertRegistered();\n\n// Raise a PermissionDeniedException if the user is not an admin.\n$actor->assertAdmin();\n\n// Check whether one of the user's groups have a permission.\n// WARNING: this should be used with caution, as it doesn't actually\n// run through the authorization process, so it doesn't account for policies.\n// It is, however, useful in implementing custom policies.\n$actorHasPermission = $actor->hasPermission(`viewForum`);\n")),(0,o.kt)("h2",{id:"custom-policies"},"Custom Policies"),(0,o.kt)("p",null,"Policies allow us to use custom logic beyond simple groups and permissions when evaluating authorization for an ability with a subject. For instance:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"We want to allow users to edit posts even if they aren't moderators, but only their own posts."),(0,o.kt)("li",{parentName:"ul"},"Depending on settings, we might allow users to rename their own discussions indefinitely, for a short period of time after posting, or not at all.")),(0,o.kt)("p",null,"As described ",(0,o.kt)("a",{parentName:"p",href:"#how-it-works"},"above"),", on any authorization check, we query all policies registered for the target's model, or any parent classes of the target's model.\nIf no target is provided, any policies registered as ",(0,o.kt)("inlineCode",{parentName:"p"},"global")," will be applied."),(0,o.kt)("p",null,'So, how does a policy get "checked"?'),(0,o.kt)("p",null,"First, we check if the policy class has a method with the same name as the ability being evaluated.\nIf so, we run it with the actor and subject as parameters.\nIf that method returns a non-null value, we return that result. Otherwise, we continue to the next step (not necessarily the next policy)."),(0,o.kt)("p",null,"Then, we check if the policy class has a method called ",(0,o.kt)("inlineCode",{parentName:"p"},"can"),". If so, we run it with the actor, ability, and subject, and return the result."),(0,o.kt)("p",null,"If ",(0,o.kt)("inlineCode",{parentName:"p"},"can")," doesn't exist or returns null, we are done with this policy, and we proceed to the next one."),(0,o.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),(0,o.kt)("a",{parentName:"h5",href:"https://github.com/DuRoom/cli"},"DuRoom CLI"))),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"You can use the CLI to automatically generate policies:"),(0,o.kt)("pre",{parentName:"div"},(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"$ duroom-cli make backend policy\n")))),(0,o.kt)("h3",{id:"example-policies"},"Example Policies"),(0,o.kt)("p",null,"Let's take a look at an example policy from ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/DuRoom/tags/blob/master/src/Access"},"DuRoom Tags"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-php"},"<?php\nnamespace DuRoom\\Tags\\Access;\n\nuse DuRoom\\Tags\\Tag;\nuse DuRoom\\User\\Access\\AbstractPolicy;\nuse DuRoom\\User\\User;\n\nclass TagPolicy extends AbstractPolicy\n{\n    /**\n     * @param User $actor\n     * @param Tag $tag\n     * @return bool|null\n     */\n    public function startDiscussion(User $actor, Tag $tag)\n    {\n        if ($tag->is_restricted) {\n            return $actor->hasPermission('tag'.$tag->id.'.startDiscussion') ? $this->allow() : $this->deny();\n        }\n    }\n\n    /**\n     * @param User $actor\n     * @param Tag $tag\n     * @return bool|null\n     */\n    public function addToDiscussion(User $actor, Tag $tag)\n    {\n        return $this->startDiscussion($actor, $tag);\n    }\n}\n")),(0,o.kt)("p",null,"We can also have global policies, which are run when ",(0,o.kt)("inlineCode",{parentName:"p"},"$user->can()")," is called without a target model instance. Again from Tags:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-php"},"<?php\n\nnamespace DuRoom\\Tags\\Access;\n\nuse DuRoom\\Settings\\SettingsRepositoryInterface;\nuse DuRoom\\Tags\\Tag;\nuse DuRoom\\User\\Access\\AbstractPolicy;\nuse DuRoom\\User\\User;\n\nclass GlobalPolicy extends AbstractPolicy\n{\n    /**\n     * @var SettingsRepositoryInterface\n     */\n    protected $settings;\n\n    public function __construct(SettingsRepositoryInterface $settings)\n    {\n        $this->settings = $settings;\n    }\n\n    /**\n     * @param DuRoom\\User\\User $actor\n     * @param string $ability\n     * @return bool|void\n     */\n    public function can(User $actor, string $ability)\n    {\n        if (in_array($ability, ['viewForum', 'startDiscussion'])) {\n            $enoughPrimary = count(Tag::getIdsWhereCan($actor, $ability, true, false)) >= $this->settings->get('min_primary_tags');\n            $enoughSecondary = count(Tag::getIdsWhereCan($actor, $ability, false, true)) >= $this->settings->get('min_secondary_tags');\n\n            if ($enoughPrimary && $enoughSecondary) {\n                return $this->allow();\n            } else {\n                return $this->deny();\n            }\n        }\n    }\n}\n")),(0,o.kt)("h3",{id:"registering-policies"},"Registering Policies"),(0,o.kt)("p",null,"Both model-based and global policies can be registered with the ",(0,o.kt)("inlineCode",{parentName:"p"},"Policy")," extender in your ",(0,o.kt)("inlineCode",{parentName:"p"},"extend.php")," file:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-php"},"use DuRoom\\Extend;\nuse DuRoom\\Tags\\Tag;\nuse YourNamespace\\Access;\n\nreturn [\n  // Other extenders\n  (new Extend\\Policy())\n    ->modelPolicy(Tag::class, Access\\TagPolicy::class)\n    ->globalPolicy(Access\\GlobalPolicy::class),\n  // Other extenders\n];\n")),(0,o.kt)("h2",{id:"frontend-authorization"},"Frontend Authorization"),(0,o.kt)("p",null,"Commonly, you'll want to use authorization results in frontend logic.\nFor example, if a user doesn't have permission to see search users, we shouldn't send requests to that endpoint.\nAnd if a user doesn't have permission to edit users, we shouldn't show menu items for that."),(0,o.kt)("p",null,"Because we can't do authorization checks in the frontend, we have to perform them in the backend, and attach them to serialization of data we're sending.\nGlobal permissions (",(0,o.kt)("inlineCode",{parentName:"p"},"viewForum"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"viewUserList"),") can be included on the ",(0,o.kt)("inlineCode",{parentName:"p"},"ForumSerializer"),", but for object-specific authorization, we may want to include those with the subject object.\nFor instance, when we return lists of discussions, we check whether the user can reply, rename, edit, and delete them, and store that data on the frontend discussion model.\nIt's then accessible via ",(0,o.kt)("inlineCode",{parentName:"p"},"discussion.canReply()")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"discussion.canEdit()"),", but there's nothing magic there: it's just another attribute sent by the serializer."),(0,o.kt)("p",null,"For an example of how to attach data to a serializer, see a ",(0,o.kt)("a",{parentName:"p",href:"/vi/extend/settings#accessing-settings"},"similar case for transmitting settings"),"."))}h.isMDXComponent=!0}}]);